<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV-/Streaming-Formatentwicklung: Deep Prompt Template</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background: #f4f4f4;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        h1, h2, h3 {
            color: #0056b3;
        }
        hr {
            border: 0;
            height: 1px;
            background: #ccc;
            margin: 20px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="radio"], input[type="checkbox"] {
            margin-right: 5px;
        }
        input[type="text"], textarea {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        button:hover {
            background-color: #0056b3;
        }
        .section {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
        }
        .radio-group label {
            display: inline-block;
            margin-right: 20px;
            font-weight: normal;
        }
        .current-date {
            font-weight: bold;
            color: #d9534f; /* Bootstrap's danger color */
        }
        #response-container {
            margin-top: 30px;
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
            display: none; /* Initial versteckt */
        }
        #response-container h3 {
            color: #0056b3;
        }
        #response-text {
            white-space: pre-wrap; /* BehÃ¤lt Formatierung bei */
            word-wrap: break-word;
        }
        .hidden-section {
            display: none;
        }
        .chat-history {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
            max-height: 200px; /* Begrenzte HÃ¶he fÃ¼r Scrollbarkeit */
            overflow-y: auto; /* Scrollbalken, wenn nÃ¶tig */
            font-size: 0.9em;
        }
        .chat-history p {
            margin: 5px 0;
            line-height: 1.4;
        }
        .chat-history .user-message {
            font-weight: bold;
            color: #28a745; /* GrÃ¼n fÃ¼r Nutzer */
        }
        .chat-history .ai-message {
            color: #007bff; /* Blau fÃ¼r KI */
        }
        .chat-history hr {
            border-top: 1px dashed #ced4da;
            margin: 10px 0;
        }
    </style>
</head>
<body>

    <h1>ðŸŽ¬ TV-/Streaming-Formatentwicklung: Deep Prompt Template</h1>
    <hr>

    <form id="formatDevelopmentForm" action="/api/generate_prompt" method="POST">
        <div class="section">
            <h2>ðŸ§  Einstieg: Was mÃ¶chtest du tun?</h2>
            <div class="radio-group">
                <input type="radio" id="action_brainstorming" name="action_type" value="brainstorming">
                <label for="action_brainstorming"><strong>Brainstorming starten</strong> â€“ Ich will zuerst locker Ideen entwickeln (Experten-Chat-Modus)</label><br>
                <input type="radio" id="action_existing_format" name="action_type" value="existing_format">
                <label for="action_existing_format"><strong>Weiterentwicklung eines bestehenden Formats</strong></label><br>
                <input type="radio" id="action_new_development" name="action_type" value="new_development">
                <label for="action_new_development"><strong>Neuentwicklung in einem bestimmten Genre</strong></label><br>
                <input type="radio" id="action_pitch_paper" name="action_type" value="pitch_paper">
                <label for="action_pitch_paper"><strong>Direkt ein Pitch Paper erstellen</strong> (Alle Details manuell eingeben)</label>
            </div>
        </div>

        <hr>

        <div id="common_expert_description" class="section hidden-section">
            <h2>ðŸ‘¤ Rollenbeschreibung (Expertenmodus aktiv)</h2>
            <p>Du bist ein erfahrener Experte der deutschsprachigen TV- und Streaminglandschaft mit 30 Jahren Berufspraxis.
            Du kennst alle Phasen von der Ideenentwicklung Ã¼ber Produktion, Postproduktion bis zur Platzierung auf Sender- oder Streamingebene.
            Du erkennst Marktchancen frÃ¼h, entwickelst innovative Formate und denkst plattformÃ¼bergreifend.
            Deine Kernzielgruppe ist 15â€“49 Jahre, du denkst aber grundsÃ¤tzlich breit und international mit.
            Du arbeitest schnell, strukturiert und zielgerichtet â€“ wie ein Produzent, der heute verkaufen muss.</p>

            <p><strong>WICHTIG:</strong> Du arbeitest <strong>tagesaktuell</strong>. Das heutige Datum ist: <span class="current-date" id="current_date"></span>.</p>
            <p>Verwende es fÃ¼r alle Recherchen, Marktanalysen, Streaming-Trends und zeitliche RelevanzprÃ¼fungen.</p>
            <p><strong>Hinweis:</strong> FÃ¼r die Generierung wird das Modell <strong>GPT-3.5-Turbo</strong> (entspricht "o3 mini") verwendet.</p>
        </div>

        <hr id="common_hr" class="hidden-section">

        <div id="brainstorming_section" class="section hidden-section">
            <h2>ðŸ’¬ Brainstorming-Modus: Locker Ideen entwickeln</h2>
            <h3>ðŸŽ¯ Ziel des Brainstormings:</h3>
            <ul>
                <li>Gemeinsam neue FormatansÃ¤tze finden</li>
                <li>Mit gezielten Fragen und strukturiertem Nachfragen durch den Experten</li>
                <li>Es muss nicht zwangslÃ¤ufig ein vollstÃ¤ndiges Format am Ende entstehen. Wir kÃ¶nnen auch ergebnislos enden.</li>
            </ul>

            <div id="brainstorming_chat_history" class="chat-history hidden-section">
                <h4>Bisheriger Chat-Verlauf:</h4>
                </div>

            <label for="brainstorming_input">Deine aktuelle Eingabe fÃ¼r den Experten:</label>
            <textarea id="brainstorming_input" name="brainstorming_input" placeholder="Z.B. 'Ich habe eine vage Idee fÃ¼r eine Reality-Show im Bereich Nachhaltigkeit' oder 'Lass uns Ã¼ber neue Doku-Formate fÃ¼r TikTok nachdenken.'"></textarea>
            
            <input type="hidden" name="chat_history_json" id="chat_history_json">
        </div>

        <div id="existing_format_section" class="section hidden-section">
            <h2>ðŸ”„ Weiterentwicklung eines bestehenden Formats</h2>
            <label for="existing_format_name">Name des bestehenden Formats:</label>
            <input type="text" id="existing_format_name" name="existing_format_name" placeholder="Z.B. 'Der groÃŸe Backwettbewerb'">

            <label for="existing_format_notes">Anmerkungen zur Weiterentwicklung (Was soll verbessert/geÃ¤ndert werden?)</label>
            <textarea id="existing_format_notes" name="existing_format_notes" placeholder="Z.B. 'Soll jÃ¼nger werden', 'Mehr Interaktion mit Social Media', 'Neue Location', 'Fokus auf bestimmte Zielgruppe'"></textarea>
        </div>

        <div id="new_development_section" class="section hidden-section">
            <h2>ðŸ†• Neuentwicklung in einem bestimmten Genre</h2>
            <label for="new_development_genre">In welchem Genre mÃ¶chtest du ein neues Format entwickeln?</label>
            <input type="text" id="new_development_genre" name="new_development_genre" placeholder="Z.B. 'Science-Fiction-Doku', 'True Crime Podcast', 'Young Adult Drama'">

            <label for="new_development_initial_ideas">Hast du schon erste Ideen oder Stichpunkte, die wir vertiefen sollen?</label>
            <textarea id="new_development_initial_ideas" name="new_development_initial_ideas" placeholder="Z.B. 'Es soll um KÃ¼nstliche Intelligenz gehen', 'Protagonisten sind Teenager', 'Soll eine Mystery-Komponente haben'"></textarea>
        </div>

        <div id="pitch_paper_section" class="section hidden-section">
            <h2>ðŸ“„ Pitch Paper Template: TV-/Streaming-Format</h2>
            <p>Bitte fÃ¼lle alle relevanten Felder aus, um ein vollstÃ¤ndiges Pitch Paper zu generieren.</p>
            <div class="section-subsection">
                <h3>ðŸ”¹ 1. AuftragsklÃ¤rung</h3>
                <input type="checkbox" id="pp_existing_format_checkbox" name="pp_assignment_type" value="Weiterentwicklung eines bestehenden Formats">
                <label for="pp_existing_format_checkbox">Weiterentwicklung eines bestehenden Formats</label><br>
                <input type="checkbox" id="pp_new_development_checkbox" name="pp_assignment_type" value="Neuentwicklung basierend auf Genre">
                <label for="pp_new_development_checkbox">Neuentwicklung basierend auf Genre:</label>
                <input type="text" id="pp_genre_input" name="pp_genre_input" placeholder="Genre eingeben">
            </div>

            <div class="section-subsection">
                <h3>ðŸ”¹ 2. Marktanalyse (2020â€“2025)</h3>
                <h4>Erfolgreiche Formate & Trends</h4>
                <label for="top_formats">Top 5 Formate (linear & Streaming)</label>
                <textarea id="top_formats" name="market_top_formats"></textarea>
                <label for="market_shares">Marktanteile / Quoten</label>
                <textarea id="market_shares" name="market_shares"></textarea>
                <label for="genre_trends">Genre- & Formattrends</label>
                <textarea id="genre_trends" name="market_genre_trends"></textarea>
                <label for="platform_trends">Plattformtrends</label>
                <textarea id="platform_trends" name="market_platform_trends"></textarea>
                <label for="target_group_dynamics">Zielgruppendynamiken</label>
                <textarea id="target_group_dynamics" name="market_target_group_dynamics"></textarea>

                <h4>Gesellschaftliche & technologische EinflÃ¼sse</h4>
                <label for="influence_factors">Einflussfaktoren (KI, Klimawandel, Social Media, etc.)</label>
                <textarea id="influence_factors" name="societal_influence_factors"></textarea>
                <label for="new_viewing_habits">Neue Sehgewohnheiten</label>
                <textarea id="new_viewing_habits" name="new_viewing_habits"></textarea>
            </div>

            <div class="section-subsection">
                <h3>ðŸ”¹ 3. Formatentwicklung</h3>
                <label for="title_claim">Titel & Claim</label>
                <input type="text" id="title_claim" name="format_title_claim">
                <label for="genre_setting_target">Genre, Setting, Zielgruppe</label>
                <input type="text" id="genre_setting_target" name="format_genre_setting_target">
                <label for="tone_visual">TonalitÃ¤t & visuelles Konzept</label>
                <textarea id="tone_visual" name="format_tone_visual"></textarea>
                <label for="usp_zeitgeist">USP & Zeitgeist</label>
                <textarea id="usp_zeitgeist" name="format_usp_zeitgeist"></textarea>
                <label for="season_episode_structure">Staffelstruktur oder Episodenaufbau</label>
                <textarea id="season_episode_structure" name="format_season_episode_structure"></textarea>
            </div>

            <div class="section-subsection">
                <h3>ðŸ”¹ 4. Plattform- & Vermarktungsstrategie</h3>
                <label for="primary_platform">PrimÃ¤re Plattform</label>
                <input type="text" id="primary_platform" name="platform_primary">
                <label for="linear_utilization">Lineare Auswertung</label>
                <input type="text" id="linear_utilization" name="platform_linear">
                <label for="digital_extension">Digitale VerlÃ¤ngerung</label>
                <input type="text" id="digital_extension" name="platform_digital">
                <label for="international_scalability">Internationale Skalierbarkeit</label>
                <input type="text" id="international_scalability" name="platform_international">
                <label for="sponsoring_options">Sponsoring- / Werbeoptionen</label>
                <textarea id="sponsoring_options" name="platform_sponsoring"></textarea>
            </div>

            <div class="section-subsection">
                <h3>ðŸ”¹ 5. Bewertung & Ausblick</h3>
                <label for="success_chances">Erfolgschancen</label>
                <textarea id="success_chances" name="evaluation_success"></textarea>
                <label for="risks_solutions">Risiken & LÃ¶sungen</label>
                <textarea id="risks_solutions" name="evaluation_risks"></textarea>
                <label for="pilot_notes">Hinweise zur Pilotphase</label>
                <textarea id="pilot_notes" name="evaluation_pilot"></textarea>
            </div>

            <div class="section-subsection">
                <h3>ðŸ”¹ 6. Revision & Selbstkontrolle</h3>
                <input type="checkbox" id="logic_checked" name="revision_logic" value="true">
                <label for="logic_checked">Logik geprÃ¼ft</label><br>
                <input type="checkbox" id="data_trends_proven" name="revision_data_trends" value="true">
                <label for="data_trends_proven">Zahlen & Trends belegt</label><br>
                <input type="checkbox" id="formatting_clear" name="revision_formatting" value="true">
                <label for="formatting_clear">Formatierung klar</label><br>
                <input type="checkbox" id="sections_complete" name="revision_sections_complete" value="true">
                <label for="sections_complete">Alle Abschnitte vollstÃ¤ndig</label>
            </div>
        </div>

        <button type="submit" id="submit_button" class="hidden-section">Absenden</button>
        <button type="button" id="reset_chat_button" class="hidden-section" style="background-color: #dc3545; margin-top: 10px;">Chat zurÃ¼cksetzen</button>
    </form>

    <div id="response-container">
        <h3>KI-Antwort:</h3>
        <p id="response-text"></p>
    </div>

    <script>
        // Setzt das aktuelle Datum
        document.getElementById('current_date').innerText = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' });

        const commonExpertDescription = document.getElementById('common_expert_description');
        const commonHr = document.getElementById('common_hr');
        const brainstormingSection = document.getElementById('brainstorming_section');
        const existingFormatSection = document.getElementById('existing_format_section');
        const newDevelopmentSection = document.getElementById('new_development_section');
        const pitchPaperSection = document.getElementById('pitch_paper_section');
        const submitButton = document.getElementById('submit_button');
        const resetButton = document.getElementById('reset_chat_button'); // Neuer Reset-Button

        const brainstormingInput = document.getElementById('brainstorming_input');
        const chatHistoryContainer = document.getElementById('brainstorming_chat_history');
        const chatHistoryJsonInput = document.getElementById('chat_history_json');

        const LOCAL_STORAGE_KEY = 'openai_chat_history'; // Key fÃ¼r LocalStorage

        // Hilfsfunktion: Chat-Verlauf aus LocalStorage laden
        function loadChatHistory() {
            try {
                const history = JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY));
                return Array.isArray(history) ? history : [];
            } catch (e) {
                console.error("Fehler beim Laden des Chat-Verlaufs aus LocalStorage:", e);
                return [];
            }
        }

        // Hilfsfunktion: Chat-Verlauf in LocalStorage speichern
        function saveChatHistory(history) {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(history));
        }

        // Hilfsfunktion: Chat-Verlauf im UI anzeigen
        function displayChatHistory(history) {
            chatHistoryContainer.innerHTML = '<h4>Bisheriger Chat-Verlauf:</h4>';
            if (history.length === 0) {
                chatHistoryContainer.classList.add('hidden-section');
                return;
            }
            chatHistoryContainer.classList.remove('hidden-section');
            history.forEach(entry => {
                const p = document.createElement('p');
                p.classList.add(entry.role === 'user' ? 'user-message' : 'ai-message');
                p.innerText = `${entry.role === 'user' ? 'Du' : 'Experte'}: ${entry.content}`;
                chatHistoryContainer.appendChild(p);
            });
            chatHistoryContainer.scrollTop = chatHistoryContainer.scrollHeight; // Zum Ende scrollen
        }

        // Hilfsfunktion: Chat-Verlauf zurÃ¼cksetzen
        function resetChatHistory() {
            localStorage.removeItem(LOCAL_STORAGE_KEY);
            displayChatHistory([]); // UI aktualisieren
            if (brainstormingInput) brainstormingInput.value = ''; // Inputfeld leeren
            document.getElementById('response-text').innerText = ''; // KI-Antwort leeren
            document.getElementById('response-container').style.display = 'none'; // KI-Antwort-Container verstecken
            toggleSections(); // Abschnitte neu laden (fÃ¼r initialen Expertentext)
        }

        const allActionSections = [
            brainstormingSection,
            existingFormatSection,
            newDevelopmentSection,
            pitchPaperSection
        ];

        function hideAllActionSections() {
            allActionSections.forEach(section => section.classList.add('hidden-section'));
            commonExpertDescription.classList.add('hidden-section');
            commonHr.classList.add('hidden-section');
            submitButton.classList.add('hidden-section');
            resetButton.classList.add('hidden-section'); // Reset-Button auch verstecken
            chatHistoryContainer.classList.add('hidden-section'); // Chat-Verlauf verstecken
        }

        function toggleSections() {
            hideAllActionSections(); // Alle ausblenden
            const selectedAction = document.querySelector('input[name="action_type"]:checked');

            // Setzt das aktuelle Datum jedes Mal neu, wenn die Sektionen gewechselt werden
            document.getElementById('current_date').innerText = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' });

            if (selectedAction) {
                commonExpertDescription.classList.remove('hidden-section');
                commonHr.classList.remove('hidden-section');
                submitButton.classList.remove('hidden-section');
                document.getElementById('response-container').style.display = 'none'; // KI-Antwort verstecken beim Wechsel

                switch (selectedAction.value) {
                    case 'brainstorming':
                        brainstormingSection.classList.remove('hidden-section');
                        resetButton.classList.remove('hidden-section'); // Reset-Button anzeigen
                        displayChatHistory(loadChatHistory()); // Chat-Historie laden und anzeigen
                        break;
                    case 'existing_format':
                        existingFormatSection.classList.remove('hidden-section');
                        resetChatHistory(); // Chat-Historie leeren, da anderer Modus
                        break;
                    case 'new_development':
                        newDevelopmentSection.classList.remove('hidden-section');
                        resetChatHistory(); // Chat-Historie leeren
                        break;
                    case 'pitch_paper':
                        pitchPaperSection.classList.remove('hidden-section');
                        resetChatHistory(); // Chat-Historie leeren
                        break;
                }
            }
        }

        // Handle Form Submission
        document.getElementById('formatDevelopmentForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Verhindert das Standard-Formular-Senden

            const form = event.target;
            const formData = new FormData(form);
            const responseContainer = document.getElementById('response-container');
            const responseText = document.getElementById('response-text');
            responseText.innerText = 'Generiere Antwort... Bitte warten.';
            responseContainer.style.display = 'block'; // Antwort-Container anzeigen

            const selectedAction = document.querySelector('input[name="action_type"]:checked');
            let currentChatHistory = [];
            let userMessage = '';

            // Nur im Brainstorming-Modus den Chat-Verlauf handhaben
            if (selectedAction && selectedAction.value === 'brainstorming') {
                currentChatHistory = loadChatHistory();
                userMessage = brainstormingInput.value;

                // FÃ¼ge die aktuelle Nutzereingabe zur Historie hinzu
                if (userMessage.trim() !== '') {
                    currentChatHistory.push({ role: 'user', content: userMessage.trim() });
                }
                
                // Setze das versteckte Feld fÃ¼r den Backend-Versand
                chatHistoryJsonInput.value = JSON.stringify(currentChatHistory);
                
                // Leere das Inputfeld nach dem Senden
                brainstormingInput.value = '';
            } else {
                // Bei anderen Modi sicherstellen, dass die Historie leer ist
                chatHistoryJsonInput.value = JSON.stringify([]);
            }


            try {
                const response = await fetch(form.action, {
                    method: form.method,
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                if (result.success) {
                    responseText.innerText = result.response;

                    // Wenn im Brainstorming-Modus, KI-Antwort zur Historie hinzufÃ¼gen und speichern
                    if (selectedAction && selectedAction.value === 'brainstorming') {
                        currentChatHistory.push({ role: 'assistant', content: result.response });
                        saveChatHistory(currentChatHistory);
                        displayChatHistory(currentChatHistory); // UI aktualisieren
                    }
                } else {
                    responseText.innerText = `Fehler: ${result.error}`;
                }
            } catch (error) {
                responseText.innerText = `Ein unerwarteter Fehler ist aufgetreten: ${error.message}`;
            }
        });

        // Event Listener fÃ¼r den Reset-Button
        if (resetButton) {
            resetButton.addEventListener('click', resetChatHistory);
        }

        // Initialisierung beim Laden der Seite
        document.addEventListener('DOMContentLoaded', function() {
            // Setzt das korrekte Datum beim Laden
            document.getElementById('current_date').innerText = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: 'long', day: 'numeric' });
            // Initial alle Aktionssektionen ausblenden
            hideAllActionSections();
            // Stellt sicher, dass das Genre-Feld bei "Neuentwicklung" im Pitch Paper korrekt initialisiert wird
            document.getElementById('pp_genre_input').disabled = !document.getElementById('pp_new_development_checkbox').checked;
        });

    </script>

</body>
</html>